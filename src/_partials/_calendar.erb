<%
    require 'active_support/core_ext'
  %>

<% current_month = (locals[:month] || Time.now).to_date %>
<% start_date = current_month.to_date.beginning_of_month.beginning_of_week %>
<% end_date = current_month.to_date.end_of_month.end_of_week %>
<% date_range = (start_date..end_date).to_a %>

<div class="calendar">

  <div class="calendar__header">
    <div class="h3">
      <%= t('date.month_names')[current_month.month] %>
      <span class="muted"><%= current_month.year %></span>
    </div>

    <div>

      <%= partial 'calendar/nav_button', month: current_month - 1.months, forward_svg: false %>

      <div class="border-r border-gray-800 inline-flex h-6"></div>

      <%= partial 'calendar/nav_button', month: current_month + 1.months, forward_svg: true %>
    </div>
  </div>	

  <div class="calendar-days calendar-days--title text-center">
    <% date_range.slice(0, 7).each do |date| %>
      <div class="calendar-day">
        <div class="h4 uppercase">
          <%= t('date.abbr_day_names')[date.wday] %>
        </div>
      </div>
    <% end %>
  </div>

  <calendar-days>
    <script type="application/json">
      <% events = site
        .collections
        .events
        .docs
        .select { |event| (current_month.beginning_of_month..current_month.end_of_month).cover?(event[:date]) }
        .collect { |event| event.data.slice(:title, :datetime, :name, :external_url, :online_event) }
      %>
      <%= { date_range: date_range, events: events }.to_json %>
    </script>

    <% date_range.each do |date| %>
      <div class="calendar-day
        <%= 'calendar-day--with-events' if site.collections.events.docs.any? { |event| event[:date].to_date == date } %>
        <%= 'calendar-day--not-in-current-month' unless (current_month.to_date.beginning_of_month..current_month.to_date.end_of_month).cover?(date) %>
        <%= 'calendar-day--past' if date < Date.today %>
        <%= 'calendar-day--today' if date == Date.today %>
        md:min-h-28
        ">
        <div class="inline-flex w-6 h-6 leading-none">
          <span class="inline-block md:hidden"><%= t('date.day_names')[date.wday] %>&nbsp;</span>
          <%= date.day %>
        </div>

        <ul>
          <% site.collections.events.docs.select { |event| event[:date].to_date == date }.each do |event| %>
            <li class="text-xs mb-1 list-disc list-inside">
              <a href="<%= event[:external_url] %>">
                <%= event[:name] %>
                <time
                  data-format="%l:%M%P"
                  data-local="time"
                  datetime="<%= Time.parse(event[:datetime]).iso8601 %>"
                  ><%= Time.parse(event[:datetime]).strftime('%H:%M %z') %></time>
              </a>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>
  </calendar-days>
</div>
